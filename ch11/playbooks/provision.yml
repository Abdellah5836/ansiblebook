#!/usr/bin/env ansible-playbook
---
- name: provision servers
  hosts: all
  vars:
    crypto_settings: faster.yml
    install_goss: true
  roles:
    - goss

  post_tasks:

    - name: ping hosts
      ping:

    - name: check python3
      stat:
        path: /usr/bin/python3
      register: python3
      tags:
        - python3

    - name: install python3
      become: true
      async: 500
      poll: 0
      package:
        name: python3
      when: not python3.stat.exists
      tags:
        - python3

    - name: install Goss
      include_role:
        name: goss
        tasks_from: install

      tags:
        - goss

    - name: improve ssh configuration
      include_role:
        name: ssh
      tags:
        - ssh
        - goss

    - name: flush handlers
      meta: flush_handlers

    - name: run Goss tests
      include_role:
        name: goss
        tasks_from: tests
